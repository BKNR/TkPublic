Tried to refactor for better readability, but in the end I just managed to hide spaghetti better.

It should be stressed that I have mostly no idea what I'm doing.
